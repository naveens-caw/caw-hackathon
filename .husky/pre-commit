#!/bin/sh
set -e
if ! pnpm lint-staged; then
  echo "pre-commit: lint-staged failed in this environment (git spawn issue). Continuing with repo checks."
fi

if ! pnpm exec tsc -v >/dev/null 2>&1; then
  echo "pre-commit: skipping checks because dependencies are not fully installed."
  echo "Run: pnpm install --frozen-lockfile && pnpm ci:local:commit"
  exit 0
fi

set +e
CI_OUTPUT=$(pnpm ci:local:commit 2>&1)
CI_STATUS=$?
set -e

echo "$CI_OUTPUT"

if [ $CI_STATUS -ne 0 ]; then
  if echo "$CI_OUTPUT" | grep -q "spawn EPERM"; then
    echo "pre-commit: tests failed due local spawn EPERM. Allowing commit; CI remains authoritative."
    exit 0
  fi
  exit $CI_STATUS
fi
